sources:
  auth_logs:
    type: file
    include:
      - /logs/auth-service.log
    read_from: end
    ignore_older: 0

  orders_logs:
    type: docker_logs
    include_containers:
      - orders-service

transforms:
  parse_json:
    type: remap
    inputs:
      - auth_logs
    source: |
      # parse message als JSON-Objekt
      . = parse_json!(.message)
      # keine Arrays, jede Zeile ist ein Event

  orders_log_parser:
    type: "remap"
    inputs:
      - "orders_logs"
    source: |
      . = parse_json!(.message)
      .timestamp = .@timestamp
      .level = .log.level
      .service = .service.name

      del(.ecs)
      del(.log)
      del(.host)
      del(.process)

sinks:
  vlogs:
    inputs:
      - parse_json
      - orders_log_parser
    type: http
    uri: http://victoria-logs:9428/insert/jsonline?_stream_fields=host,container_name&_msg_field=message&_time_field=timestamp
    compression: gzip
    encoding:
      codec: json
    framing:
      method: newline_delimited
    healthcheck:
      enabled: true

  debug_file:
    type: file
    inputs:
      - parse_json
    path: /logs/vector-output.ndjson
    encoding:
      codec: json
